<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>
        <link rel="stylesheet" href="../styles/style.css" />
    </head>

    <body>
        <div id="static-form-container">
            <fw-tabs>
                <fw-tab slot="tab" panel="information">Information</fw-tab>
                <fw-tab slot="tab" panel="tabs">Tabs Config</fw-tab>
                <!-- <fw-tab slot="tab" panel="template">Document Template</fw-tab> -->
                <fw-tab slot="tab" panel="state">State</fw-tab>
                <fw-tab slot="tab" panel="state-change">State Change</fw-tab>
                <fw-tab-panel name="information">
                    <fw-form id="formCreate">
                        <fw-form-control
                            type="DROPDOWN"
                            id="workspace_id"
                            name="workspace_id"
                            label="Workspace"
                            required="true"
                            placeholder="Select Workspace"
                        ></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="service_item_id"
                            name="service_item_id"
                            label="Service Item"
                            required="true"
                            placeholder="Select Service Item"
                        ></fw-form-control>
                        <fw-form-control id="app_code" name="app_code" label="App Code" required="true" placeholder="Enter App Code"></fw-form-control>
                        <fw-form-control id="app_name" name="app_name" label="App Name" required="true" placeholder="Enter App Name"></fw-form-control>
                        <fw-form-control id="app_url" name="app_url" label="App URL" required="true" placeholder="Enter App URL"></fw-form-control>
                        <fw-form-control
                            type="PARAGRAPH"
                            id="app_description"
                            name="app_description"
                            rows="3"
                            maxlength="190"
                            minlength="5"
                            label="App Description"
                            placeholder="Enter App Description"
                        ></fw-form-control>
                        <fw-form-control
                            id="process_code"
                            name="process_code"
                            label="Process Code"
                            required="true"
                            placeholder="Enter Process Code"
                        ></fw-form-control>
                        <fw-form-control
                            id="process_name"
                            name="process_name"
                            label="Process Name"
                            required="true"
                            placeholder="Enter Process Name"
                        ></fw-form-control>
                        <fw-form-control
                            id="process_url"
                            name="process_url"
                            label="Process_URL"
                            required="true"
                            placeholder="Enter Process_URL"
                        ></fw-form-control>
                        <fw-form-control
                            type="PARAGRAPH"
                            id="process_image"
                            name="process_image"
                            rows="3"
                            maxlength="190"
                            minlength="5"
                            label="Process Image SVG"
                            placeholder="Enter Process Image SVG"
                        >
                        </fw-form-control>
                        <fw-form-control
                            type="PARAGRAPH"
                            id="process_description"
                            name="process_description"
                            rows="3"
                            maxlength="190"
                            minlength="5"
                            label="Description"
                            placeholder="Enter Description"
                        >
                        </fw-form-control>
                        <fw-form-control type="CHECKBOX" id="is_active" name="is_active" label="Is Active"></fw-form-control>
                        <!-- <fw-form-control
                            type="DROPDOWN"
                            id="related_custom_object"
                            name="related_custom_object"
                            label="Related Custom Object"
                            placeholder="Select Custom Object"
                        >
                        </fw-form-control> -->
                        <fw-form-control
                            type="MULTI_SELECT"
                            id="related_custom_objects"
                            name="related_custom_objects"
                            label="Related Custom Objects"
                            placeholder="Select Custom Object"
                        >
                        </fw-form-control>
                    </fw-form>
                </fw-tab-panel>
                <fw-tab-panel name="tabs">
                    <div style="display: flex; justify-content: space-between; margin: 15px 0">
                        <fw-button id="new-tab" color="secondary">Add New</fw-button>
                    </div>
                    <fw-data-table id="data-table-tabs"></fw-data-table>
                </fw-tab-panel>
                <fw-tab-panel name="template">
                    <fw-form id="formDocument">
                        <fw-form-control
                            type="TEXT"
                            id="template_name"
                            name="template_name"
                            label="Template Name"
                            required="true"
                            placeholder="Enter template name"
                        ></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="type"
                            name="type"
                            label="Template Type"
                            required="true"
                            placeholder="Select type"
                        ></fw-form-control>
                        <fw-form-control type="FILES" id="file" name="file" label="Select File" required="true"></fw-form-control>
                    </fw-form>
                </fw-tab-panel>
                <fw-tab-panel name="state">
                    <fw-data-table id="data-table-states" label="Values"></fw-data-table>
                </fw-tab-panel>
                <fw-tab-panel name="state-change">
                    <fw-data-table id="data-table-state-changes" label="Values"></fw-data-table>
                </fw-tab-panel>
            </fw-tabs>
            <div class="bottom">
                <fw-button id="closeModal" color="secondary">Close</fw-button>
                <fw-button id="submit" color="primary">Save</fw-button>
            </div>
        </div>
        <fw-modal id="modal-detail">
            <fw-modal-title>
                <span>Tab Configuration</span>
            </fw-modal-title>
            <fw-modal-content>
                <fw-form id="form-tab">
                    <fw-form-control
                        type="DROPDOWN"
                        id="custom_object"
                        name="custom_object_id"
                        label="Custom Object"
                        placeholder="Select custom object"
                    ></fw-form-control>
                    <fw-form-control type="TEXT" id="tab_name" name="tab_name" label="Tab Name" placeholder="Enter tab name"></fw-form-control>
                    <fw-form-control type="TEXT" id="tab_code" name="tab_code" label="Tab Code" placeholder="Enter tab code"></fw-form-control>
                    <fw-form-control type="CHECKBOX" id="is_table" name="is_table" label="Is Table"></fw-form-control>
                </fw-form>
                <fw-select multiple id="fields" label="Fields" placeholder="Select fields"></fw-select>
            </fw-modal-content>
            <fw-modal-footer>
                <fw-button id="form-tab-close" color="secondary">Close</fw-button>
                <fw-button id="form-tab-add">Add</fw-button>
                <fw-button id="form-tab-save">Save</fw-button>
            </fw-modal-footer>
        </fw-modal>
        <script src="https://static.freshdev.io/fdk/2.0/assets/fresh_client.js"></script>
        <script type="module" src="https://cdn.jsdelivr.net/npm/@freshworks/crayons@v4/dist/crayons/crayons.esm.js"></script>
        <script nomodule src="https://cdn.jsdelivr.net/npm/@freshworks/crayons@v4/dist/crayons/crayons.js"></script>
        <script src="../scripts/helper.js"></script>
        <script src="../scripts/constant.js"></script>
        <script src="../scripts/tabs.js"></script>
        <script>
            window.frsh_init().then(function (client) {
                var context = {};
                var customObject = [];
                var formCreate = document.querySelector("#formCreate");
                var formDocument = document.querySelector("#formDocument");
                var formTab = document.querySelector("#form-tab");
                var tableTab = document.querySelector("#data-table-tabs");
                document.getElementById("closeModal").addEventListener("click", function () {
                    client.instance.close();
                });
                formCreate.addEventListener("fwFormValueChanged", (e) => {
                    if (e.detail.field == "workspace_id") {
                        client.instance.send({
                            message: {
                                type: ACTION_TYPES.CUSTOM_OBJECT,
                                data: e.detail.value
                            }
                        });
                    }
                    if (e.detail.field == "related_custom_objects") {
                        const filteredItems = customObject.filter((item) => e.detail.value.includes(item.id.toString()));
                        generateCustomObject("custom_object", filteredItems);
                    }
                });
                formTab.addEventListener("fwFormValueChanged", (e) => {
                    if (e.detail.field == "custom_object_id" && e.detail.value) {
                        client.instance.send({
                            message: {
                                type: ACTION_TYPES.CUSTOM_OBJECT_FIELDS,
                                data: e.detail.value
                            }
                        });
                    }
                });
                document.querySelector("#submit").addEventListener("click", async (e) => {
                    const { values, isValid } = await formCreate.doSubmit(e);
                    await tableTab.selectAllRows();
                    const tabValues = await tableTab.getSelectedRows();
                    console.log(tabValues);
                    client.instance.send({
                        message: {
                            type: context.type,
                            data: { ...values, related_custom_objects: values.related_custom_objects?.join(";") },
                            id: context.detail?.bo_display_id
                        }
                    });
                    client.instance.send({
                        message: {
                            type: ACTION_TYPES.TABS_CONFIG,
                            data: {
                                service_item_id: values.service_item_id,
                                tabs: tabValues
                            }
                        }
                    });
                });

                client.instance.receive(function (event) {
                    let data = event.helper.getData();
                    if (data.type === ACTION_TYPES.CLOSE_MODAL) client.instance.close();
                    if (data.type === ACTION_TYPES.CUSTOM_OBJECT) {
                        customObject = data.data;
                        generateCustomObject("related_custom_objects", customObject);
                        formCreate.setFieldValue("related_custom_objects", context.detail?.related_custom_objects?.split(";"));
                    }
                    if (data.type === ACTION_TYPES.CUSTOM_OBJECT_FIELDS) {
                        const list = data.data;
                        generateSelectFields("fields", list);
                        document.getElementById(fields);
                    }
                });

                client.instance.context().then(function (c) {
                    context = c.data;
                    if (context.type === ACTION_TYPES.SERVICE_REQUEST_CREATE || context.type === ACTION_TYPES.SERVICE_REQUEST_UPDATE) {
                        const { detail, data } = context;
                        generateSelect("service_item_id", data.serviceItems, context);
                        generateWorkspace("workspace_id", data.workspaces, context);
                        formCreate.setFieldValue(
                            "process_image",
                            `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" fill="none">
                                <rect width="32" height="32" fill="white"/>
                                <path d="M21.5455 9.63672H7V26.0004H21.5455V9.63672Z" stroke="#232628" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M9.72656 6H25.1811V24.1818" stroke="#232628" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M10.6406 14.1836H17.9134" stroke="#232628" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M10.6406 17.8164H17.9134" stroke="#232628" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M10.6406 21.457H14.277" stroke="#232628" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>`
                        );
                        if (!detail) return;
                        Object.keys(detail).forEach(function (key) {
                            if (key === "related_custom_objects") return;
                            formCreate.setFieldValue([key], detail[key]);
                        });
                        generateDataTable([]);
                        if (data.tabs) {
                            generateDataTable(data.tabs);
                        }
                        generateState(data.state?.states);
                        generateStateChange(data.state?.state_changes);
                    }
                });
            });
            function generateSelect(container, list, context) {
                const options = list?.map((item) => {
                    return { value: String(item.display_id), text: item.name };
                });
                document.getElementById(container).choices = options;
                document.getElementById(container).value = String(context.detail?.service_item_id);
            }

            function generateWorkspace(container, list, context) {
                const options = list?.map((item) => {
                    return { value: String(item.data.workspace_id), text: item.data.name };
                });
                document.getElementById(container).choices = options;
                document.getElementById(container).value = String(context.detail?.workspace_id);
            }

            function generateState(states) {
                const columns = [
                    {
                        key: "state",
                        text: "State"
                    },
                    {
                        key: "state_name",
                        text: "State Name"
                    }
                ];
                var datatable = document.getElementById("data-table-states");
                datatable.columns = columns;
                datatable.rows = states?.map((item) => item.data)?.sort((a, b) => a.state.localeCompare(b.state));
            }
            function generateStateChange(state_changes) {
                const columns = [
                    {
                        key: "name",
                        text: "Name"
                    },
                    {
                        key: "current_state",
                        text: "State"
                    },
                    {
                        key: "configuration_type",
                        text: "Configuration Type"
                    }
                ];
                var datatable = document.getElementById("data-table-state-changes");
                datatable.columns = columns;
                datatable.rows = state_changes?.map((item) => item.data)?.sort((a, b) => a.current_state.localeCompare(b.current_state));
            }
        </script>
    </body>
</html>
