<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>
        <link rel="stylesheet" href="../styles/style.css" />
    </head>

    <body>
        <div id="static-form-container">
            <fw-form id="formCreate">
                <fw-tabs>
                    <fw-tab slot="tab" panel="information">Information</fw-tab>
                    <fw-tab slot="tab" panel="approval">Approval/Submit</fw-tab>
                    <fw-tab slot="tab" panel="condition">Condition</fw-tab>
                    <fw-tab-panel name="information">
                        <fw-form-control
                            type="DROPDOWN"
                            id="app_code"
                            name="app_code"
                            label="App Name"
                            required="true"
                            placeholder="Enter App Name"
                        ></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="process_code"
                            name="process_code"
                            label="Process Name"
                            required="true"
                            placeholder="Enter Process Name"
                        ></fw-form-control>
                        <fw-form-control id="name" name="name" label="Name" required="true" placeholder="Enter Name"></fw-form-control>
                        <fw-form-control
                            id="duration"
                            name="duration"
                            label="Duration (Minutes)"
                            required="true"
                            placeholder="Enter Duration (Minutes)"
                        ></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="calendar_type"
                            name="calendar_type"
                            label="Calendar Type"
                            required="true"
                            placeholder="Select Calendar Type"
                        ></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="current_state"
                            name="current_state"
                            label="Current State"
                            required="true"
                            placeholder="Select Current State"
                        ></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="configuration_type"
                            name="configuration_type"
                            label="Configuration Type"
                            placeholder="Select Configuration Type"
                        ></fw-form-control>
                    </fw-tab-panel>
                    <fw-tab-panel name="approval">
                        <fw-form-control type="DROPDOWN" id="approver" name="approver" label="Approver" placeholder="Select Approver"></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="next_approval_group"
                            name="next_approval_group"
                            label="Requester Approval Group"
                            placeholder="Select Requester Group Approval"
                            disabled
                        ></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="next_agent_group_approval"
                            name="next_agent_group_approval"
                            label="Agent Approval Group"
                            placeholder="Select Agent Group Approval "
                            disabled
                        ></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="approval_type"
                            name="approval_type"
                            label=" Approval Type"
                            placeholder="Select Approval Type"
                        ></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="email_template_code"
                            name="email_template_code"
                            label="Approval Email Template"
                            placeholder="Select Email Template"
                        ></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="expired_new_state"
                            name="expired_new_state"
                            label="Expired New State"
                            placeholder="Select Expired New State"
                        ></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="warning_email_template_code"
                            name="warning_email_template_code"
                            label="Warning Email Template"
                            placeholder="Select Email Template"
                        ></fw-form-control>
                        <fw-form-control
                            type="MULTI_SELECT"
                            id="send_warning_email_before"
                            name="send_warning_email_before"
                            label="Send Warning Email Before"
                            placeholder="Send Warning Email Before"
                        ></fw-form-control>
                    </fw-tab-panel>
                    <fw-tab-panel name="condition">
                        <fw-form-control type="DROPDOWN" id="condition_field" name="condition_field" label="Field" placeholder="Select Field"></fw-form-control>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px">
                            <fw-button id="new-condition" color="secondary">Add New</fw-button>
                        </div>
                        <fw-data-table id="data-table-values" label="Values"></fw-data-table>
                    </fw-tab-panel>
                </fw-tabs>
            </fw-form>
            <div class="bottom">
                <fw-button id="closeModal" color="secondary">Close</fw-button>
                <fw-button id="submit" color="primary">Save</fw-button>
            </div>
        </div>
        <fw-modal id="modal-detail">
            <fw-modal-title>
                <span>Condition Configuration</span>
            </fw-modal-title>
            <fw-modal-content>
                <fw-form id="form-condition">
                    <fw-form-control type="DROPDOWN" id="condition-state" name="state" label="State" placeholder="Select State"></fw-form-control>
                    <fw-form-control type="DROPDOWN" disabled id="condition_detail_field" name="condition_detail_field" label="Field"></fw-form-control>
                    <fw-form-control type="DROPDOWN" id="operator" name="operator" label="Operator" placeholder="Select Operator"></fw-form-control>
                    <fw-form-control type="PARAGRAPH" id="value" name="value" label="Value (Separated by ;)" placeholder="Enter Value"></fw-form-control>
                </fw-form>
            </fw-modal-content>
            <fw-modal-footer>
                <fw-button id="form-condition-close" color="secondary">Close</fw-button>
                <fw-button id="form-condition-add">Add</fw-button>
                <fw-button id="form-condition-save">Save</fw-button>
            </fw-modal-footer>
        </fw-modal>
        <script src="https://static.freshdev.io/fdk/2.0/assets/fresh_client.js"></script>
        <script type="module" src="https://cdn.jsdelivr.net/npm/@freshworks/crayons@v4/dist/crayons/crayons.esm.js"></script>
        <script nomodule src="https://cdn.jsdelivr.net/npm/@freshworks/crayons@v4/dist/crayons/crayons.js"></script>
        <script src="../scripts/constant.js"></script>
        <script src="../scripts/helper.js"></script>
        <script src="../scripts/condition.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                window.frsh_init().then(function (client) {
                    var context = {};
                    var categories = [];
                    var states = [];
                    var formCreate = document.querySelector("#formCreate");
                    generateSelect();
                    document.getElementById("closeModal").addEventListener("click", function () {
                        client.instance.close();
                    });
                    formCreate.addEventListener("fwFormValueChanged", (e) => {
                        if (e.detail.field == "app_code") {
                            generateProcess(
                                categories?.filter((item) => item.data.app_code == e.detail.value),
                                ""
                            );
                        }
                        if (e.detail.field == "process_code") {
                            const newStateList = states?.filter(
                                (item) => item.data.app_code == document.getElementById("app_code").value && item.data.process_code == e.detail.value
                            );
                            generateState("current_state", newStateList, context);
                            generateState("expired_new_state", newStateList, context);
                            generateState("condition-state", newStateList, context);
                            client.instance.send({
                                message: {
                                    type: ACTION_TYPES.SERVICE_ITEM,
                                    data: {
                                        app_code: document.getElementById("app_code").value,
                                        process_code: e.detail.value
                                    }
                                }
                            });
                        }
                        if (e.detail.field == "approver") {
                            if (e.detail.value == 4) {
                                document.getElementById("next_approval_group").disabled = false;
                                document.getElementById("next_agent_group_approval").disabled = false;
                            } else {
                                document.getElementById("next_approval_group").disabled = true;
                                document.getElementById("next_agent_group_approval").disabled = true;
                            }
                        }
                    });
                    document.querySelector("#submit").addEventListener("click", async (e) => {
                        const { values, isValid } = await formCreate.doSubmit(e);
                        const table = document.getElementById("data-table-values");
                        await table.selectAllRows();
                        const tableValues = await table.getSelectedRows();
                        client.instance.send({
                            message: {
                                type: context.type,
                                data: {
                                    ...values,
                                    send_warning_email_before: values.send_warning_email_before?.join(";"),
                                    condition_values: JSON.stringify(tableValues)
                                },
                                id: context.detail?.bo_display_id
                            }
                        });
                    });
                    client.instance.receive(function (event) {
                        let data = event.helper.getData();
                        if (data.type === ACTION_TYPES.CLOSE_MODAL) client.instance.close();
                        if (data.type === ACTION_TYPES.SERVICE_ITEM) {
                            const fields = data.data;
                            generateFields("condition_field", fields);
                            generateFields("condition_detail_field", fields);
                            formCreate.setFieldValue("condition_field", context.detail?.condition_field);
                        }
                    });
                    client.instance.context().then(function (c) {
                        context = c.data;
                        if (context.type === ACTION_TYPES.GROUP_APPROVAL_CREATE || context.type === ACTION_TYPES.GROUP_APPROVAL_UPDATE) {
                            const { detail, data } = context;
                            categories = data.categories;
                            states = data.states;
                            generateApp(data.apps, context.detail?.app_code);
                            generateProcess(
                                categories?.filter((item) => item.data.app_code == context.detail?.app_code),
                                ""
                            );
                            generateGroup("next_approval_group", data.requesterGroups, context);
                            generateGroup("next_agent_group_approval", data.agentGroups, context);
                            const newStates = states?.filter(
                                (item) => item.data.app_code == context.detail?.app_code && item.data.process_code == context.detail?.process_code
                            );
                            generateState("current_state", newStates, context);
                            generateState("expired_new_state", newStates, context);
                            generateState("condition-state", newStates, context);
                            generateEmailTemplate("email_template_code", data.templates, context);
                            generateEmailTemplate("warning_email_template_code", data.templates, context);

                            if (!detail) return;
                            Object.keys(detail).forEach(function (key) {
                                formCreate.setFieldValue([key], detail[key]);
                            });
                            formCreate.setFieldValue("send_warning_email_before", detail.send_warning_email_before?.split(";"));
                            generateDataTable(detail.condition_values, newStates);
                            if (detail.approver == 4) {
                                document.getElementById("next_approval_group").disabled = false;
                                document.getElementById("next_agent_group_approval").disabled = false;
                            }
                        }
                    });
                });
                function generateSelect() {
                    const calendar_type = [
                        { value: "business", text: "8/5 Calendar" },
                        { value: "normal", text: "24/7 Calendar" }
                    ];
                    const configuration_type = [
                        { value: "approval", text: "Approval" },
                        { value: "condition", text: "Condition" }
                    ];
                    const approver = [
                        { value: "1", text: "Reporting Manager" },
                        { value: "2", text: "Department Head" },
                        { value: "3", text: "Selected Department" },
                        { value: "4", text: "Group" }
                    ];
                    const approval_type = [
                        { value: "1", text: "To be approved by Everyone" },
                        { value: "2", text: "To be approved by Anyone" },
                        { value: "3", text: "To be approved by Majority" },
                        { value: "4", text: "To be approved by First Responder" }
                    ];
                    const send_warning_email_before = [
                        { value: "1day", text: "1 day" },
                        { value: "4hours", text: "4 hours" },
                        { value: "1hours", text: "1 hours" },
                        { value: "30mins", text: "30 mins" }
                    ];
                    const operator = [
                        { value: "condition", text: "Condition" },
                        { value: "equals", text: "Equals" },
                        { value: "contains", text: "Contains" },
                        { value: "between", text: "Between" },
                        { value: "greater_than", text: "Greater than" },
                        { value: "greater_than_or_equal", text: "Greater than or Equal to" },
                        { value: "less_than", text: "Less than" },
                        { value: "less_than_or_equal", text: "Less than or Equal to" }
                    ];
                    document.getElementById("calendar_type").choices = calendar_type;
                    document.getElementById("approver").choices = approver;
                    document.getElementById("approval_type").choices = approval_type;
                    document.getElementById("configuration_type").choices = configuration_type;
                    document.getElementById("send_warning_email_before").choices = send_warning_email_before;
                    document.getElementById("operator").choices = operator;
                }
            });
        </script>
    </body>
</html>
