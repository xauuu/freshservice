<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../styles/style.css">
</head>

<body>
    <div id="static-form-container">
        <fw-form id="formCreate">
            <fw-tabs>
                <fw-tab slot="tab" panel="information">Information</fw-tab>
                <fw-tab slot="tab" panel="approval">Approval/Submit</fw-tab>
                <fw-tab slot="tab" panel="reject">Reject</fw-tab>
                <fw-tab slot="tab" panel="expired">Expired</fw-tab>
                <fw-tab-panel name="information">
                    <fw-form-control type="DROPDOWN" id="app_code" name="app_code" label="App Name" required="true"
                        placeholder="Enter App Name"></fw-form-control>
                    <fw-form-control type="DROPDOWN" id="process_code" name="process_code" label="Process Name"
                        required="true" placeholder="Enter Process Name"></fw-form-control>
                    <fw-form-control id="name" name="name" label="Name" required="true"
                        placeholder="Enter Name"></fw-form-control>
                    <fw-form-control id="duration" name="duration" label="Duration (Minutes)" required="true"
                        placeholder="Enter Duration (Minutes)"></fw-form-control>
                    <fw-form-control type="DROPDOWN" id="calendar_type" name="calendar_type" label="Calendar Type"
                        required="true" placeholder="Select Calendar Type"></fw-form-control>
                    <fw-form-control type="DROPDOWN" id="current_state" name="current_state" label="Current State"
                        required="true" placeholder="Select Current State"></fw-form-control>
                    <fw-form-control type="CHECKBOX" id="is_state_end" name="is_state_end"
                        label="Is State End"></fw-form-control>
                    <div id="is_end" style="display: none;">
                        <fw-form-control type="CHECKBOX" id="is_send_email" name="is_send_email"
                            label="Is Send Email"></fw-form-control>
                        <fw-form-control type="CHECKBOX" id="is_attach_file" name="is_attach_file"
                            label="Is attach file"></fw-form-control>
                    </div>
                    <fw-form-control type="DROPDOWN" id="email_template_code" name="email_template_code"
                        label="Email Template" placeholder="Enter Email Template"></fw-form-control>
                </fw-tab-panel>
                <fw-tab-panel name="approval">
                    <fw-form-control type="DROPDOWN" id="approver" name="approver" label="Approver"
                        placeholder="Select Approver"></fw-form-control>
                    <fw-form-control type="DROPDOWN" id="next_approval_group" name="next_approval_group"
                        label="Next Approval Group" placeholder="Select Next Approval Group" disabled></fw-form-control>
                    <fw-form-control type="CHECKBOX" id="is_not_send_approval" name="is_not_send_approval"
                        label="Do not Send Approval Email"></fw-form-control>
                    <fw-form-control type="DROPDOWN" id="approval_type" name="approval_type" label=" Approval Type"
                        placeholder="Select Approval Type"></fw-form-control>
                    <fw-form-control type="DROPDOWN" id="new_state" name="new_state" label="New State"
                        placeholder="Select New State"></fw-form-control>
                    <fw-form-control type="DROPDOWN" id="approval_email_template_code"
                        name="approval_email_template_code" label="Email Template"
                        placeholder="Enter Email Template"></fw-form-control>
                </fw-tab-panel>
                <fw-tab-panel name="reject">
                    <fw-form-control type="DROPDOWN" id="reject_next_approval_group" name="reject_next_approval_group"
                        label="Reject Approval Group" placeholder="Select Reject Approval Group"></fw-form-control>
                    <fw-form-control type="DROPDOWN" id="reject_new_state" name="reject_new_state"
                        label="Reject New State" placeholder="Select Reject New State"></fw-form-control>
                    <fw-form-control type="DROPDOWN" id="reject_email_template_code" name="reject_email_template_code"
                        label="Reject Email Template" placeholder="Enter Reject Email Template"></fw-form-control>
                </fw-tab-panel>
                <fw-tab-panel name="expired">
                    <fw-form-control type="DROPDOWN" id="expired_next_approval_group" name="expired_next_approval_group"
                        label="Expired Approval Group" placeholder="Select Expired Approval Group"></fw-form-control>
                    <fw-form-control type="DROPDOWN" id="expired_new_state" name="expired_new_state"
                        label="Expired New State" placeholder="Select expired New State"></fw-form-control>
                    <fw-form-control type="DROPDOWN" id="expired_email_template_code" name="expired_email_template_code"
                        label="Expired Email Template" placeholder="Enter Expired Email Template"></fw-form-control>
                </fw-tab-panel>
            </fw-tabs>
        </fw-form>
        <div class="bottom">
            <fw-button id="closeModal" color="secondary">Close</fw-button>
            <fw-button id="submit" color="primary">Save</fw-button>
        </div>
    </div>
    <script src="https://static.freshdev.io/fdk/2.0/assets/fresh_client.js"></script>
    <script type="module"
        src="https://cdn.jsdelivr.net/npm/@freshworks/crayons@v4/dist/crayons/crayons.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@freshworks/crayons@v4/dist/crayons/crayons.js"></script>
    <script src="../scripts/constant.js"></script>
    <script src="../scripts/helper.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            window.frsh_init().then(function (client) {
                var context = {}
                var categories = []
                var states = []
                var formCreate = document.querySelector("#formCreate")
                generateSelect()
                document.getElementById("closeModal").addEventListener("click", function () {
                    client.instance.close();
                });
                formCreate.addEventListener('fwFormValueChanged', (e) => {
                    if (e.detail.field == 'app_code') {
                        generateProcess(categories?.filter(item => item.data.app_code == e.detail.value), "")
                    }
                    if (e.detail.field == 'process_code') {
                        const newStateList = states?.filter(item => item.data.app_code == document.getElementById("app_code").value && item.data.process_code == e.detail.value)
                        generateState('current_state', newStateList, context)
                        generateState('new_state', newStateList, context)
                        generateState('reject_new_state', newStateList, context)
                        generateState('expired_new_state', newStateList, context)
                    }
                    if (e.detail.field == 'approver') {
                        if (e.detail.value == 4) {
                            document.getElementById("next_approval_group").disabled = false
                        } else {
                            document.getElementById("next_approval_group").disabled = true
                        }
                    }
                    if (e.detail.field == 'is_state_end') {
                        if (e.detail.value) {
                            document.getElementById("is_end").style.display = "block"
                        } else {
                            document.getElementById("is_end").style.display = "none"
                            formCreate.setFieldValue(["is_send_email"], false);
                            formCreate.setFieldValue(["is_attach_file"], false);
                        }
                    }
                });
                document.querySelector('#submit').addEventListener('click', async (e) => {
                    const { values, isValid } = await formCreate.doSubmit(e);
                    client.instance.send({
                        message: {
                            type: context.type,
                            data: {
                                ...values,
                                is_state_end: Number(values.is_state_end),
                                is_send_email: Number(values.is_send_email),
                                is_attach_file: Number(values.is_attach_file),
                                is_not_send_approval: Number(values.is_not_send_approval)
                            },
                            id: context.detail?.bo_display_id
                        }
                    });

                });
                client.instance.receive(function (event) {
                    let data = event.helper.getData();
                    if (data.type === ACTION_TYPES.CLOSE_MODAL) client.instance.close();
                    if (data.type === ACTION_TYPES.LIST_DATA) {

                    }
                });
                client.instance.context().then(
                    function (c) {
                        context = c.data
                        if (context.type === ACTION_TYPES.GROUP_APPROVAL_CREATE || context.type === ACTION_TYPES.GROUP_APPROVAL_UPDATE) {
                            const { detail, data } = context
                            categories = data.categories
                            states = data.states
                            generateApp(data.apps, context.detail?.app_code)
                            generateProcess(
                                categories?.filter(item => item.data.app_code == context.detail?.app_code),
                                ""
                            )
                            generateGroup("next_approval_group", data.requesterGroups, context)
                            generateGroup("reject_next_approval_group", data.requesterGroups, context)
                            generateGroup("expired_next_approval_group", data.requesterGroups, context)
                            const newStates = states?.filter(item => item.data.app_code == context.detail?.app_code && item.data.process_code == context.detail?.process_code)
                            generateState('current_state', newStates, context)
                            generateState('new_state', newStates, context)
                            generateState('reject_new_state', newStates, context)
                            generateState('expired_new_state', newStates, context)
                            generateEmailTemplate('email_template_code', data.templates, context)
                            generateEmailTemplate('approval_email_template_code', data.templates, context)
                            generateEmailTemplate('reject_email_template_code', data.templates, context)
                            generateEmailTemplate('expired_email_template_code', data.templates, context)

                            if (!detail) return
                            Object.keys(detail).forEach(function (key) {
                                formCreate.setFieldValue([key], detail[key]);
                            });
                            if (detail.approver == 4) document.getElementById("next_approval_group").disabled = false
                            if (Boolean(detail.is_state_end)) document.getElementById("is_end").style.display = "block"
                        }
                    }
                );
            });
            function generateSelect() {
                const calendar_type = [
                    { value: 'business', text: '8/5 Calendar' },
                    { value: 'normal', text: '24/7 Calendar' }
                ]
                const approver = [
                    { value: '1', text: 'Reporting Manager' },
                    { value: '2', text: 'Department Head' },
                    { value: '3', text: 'Selected Department' },
                    { value: '4', text: 'Group' },
                ]
                const approval_type = [
                    { value: '1', text: 'To be approved by Everyone' },
                    { value: '2', text: 'To be approved by Anyone' },
                    { value: '3', text: 'To be approved by Majority' },
                    { value: '4', text: 'To be approved by First Responder' },
                ]
                document.getElementById("calendar_type").choices = calendar_type;
                document.getElementById("approver").choices = approver;
                document.getElementById("approval_type").choices = approval_type;
            }
        });
    </script>
</body>

</html>