<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>
        <link rel="stylesheet" href="../styles/style.css" />
        <style>
            fw-tab-panel {
                margin-bottom: 50px;
            }
        </style>
    </head>

    <body>
        <div id="static-form-container">
            <fw-tabs>
                <fw-tab slot="tab" panel="information">Information</fw-tab>
                <fw-tab slot="tab" panel="approval">Approval/Submit</fw-tab>
                <fw-tab slot="tab" panel="condition">Condition</fw-tab>
                <fw-tab slot="tab" panel="file">Generate File</fw-tab>
                <fw-tab-panel name="information">
                    <fw-form id="formCreate">
                        <fw-form-control
                            type="DROPDOWN"
                            id="app_code"
                            name="app_code"
                            label="App Name"
                            required="true"
                            placeholder="Enter App Name"
                        ></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="process_code"
                            name="process_code"
                            label="Process Name"
                            required="true"
                            placeholder="Enter Process Name"
                        ></fw-form-control>
                        <fw-form-control id="name" name="name" label="Name" required="true" placeholder="Enter Name"></fw-form-control>
                        <fw-form-control
                            id="duration"
                            name="duration"
                            label="Duration (Minutes)"
                            required="true"
                            placeholder="Enter Duration (Minutes)"
                        ></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="calendar_type"
                            name="calendar_type"
                            label="Calendar Type"
                            required="true"
                            placeholder="Select Calendar Type"
                        ></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="current_state"
                            name="current_state"
                            label="Current State"
                            required="true"
                            placeholder="Select Current State"
                        ></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="configuration_type"
                            name="configuration_type"
                            label="Configuration Type"
                            placeholder="Select Configuration Type"
                        ></fw-form-control>
                    </fw-form>
                </fw-tab-panel>
                <fw-tab-panel name="approval">
                    <fw-form id="formApproval">
                        <fw-form-control type="DROPDOWN" id="approver" name="approver" label="Approver" placeholder="Select Approver"></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="next_approval_group"
                            name="next_approval_group"
                            label="Requester Approval Group"
                            placeholder="Select Requester Group Approval"
                            disabled
                        ></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="next_agent_group_approval"
                            name="next_agent_group_approval"
                            label="Agent Approval Group"
                            placeholder="Select Agent Group Approval "
                            disabled
                        ></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="approval_type"
                            name="approval_type"
                            label=" Approval Type"
                            placeholder="Select Approval Type"
                        ></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="email_template_code"
                            name="email_template_code"
                            label="Approval Email Template"
                            placeholder="Select Email Template"
                        ></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="expired_new_state"
                            name="expired_new_state"
                            label="Expired New State"
                            placeholder="Select Expired New State"
                        ></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="warning_email_template_code"
                            name="warning_email_template_code"
                            label="Warning Email Template"
                            placeholder="Select Email Template"
                        ></fw-form-control>
                        <fw-form-control
                            type="MULTI_SELECT"
                            id="send_warning_email_before"
                            name="send_warning_email_before"
                            label="Send Warning Email Before"
                            placeholder="Send Warning Email Before"
                        ></fw-form-control>
                    </fw-form>
                </fw-tab-panel>
                <fw-tab-panel name="condition">
                    <fw-form id="formCondition">
                        <fw-form-control type="DROPDOWN" id="object_type" name="object_type" label="Object Type" placeholder="Select type"></fw-form-control>
                        <fw-form-control
                            style="display: none"
                            type="DROPDOWN"
                            id="condition_custom_object"
                            name="custom_object_id"
                            label="Custom Object"
                            placeholder="Select custom object"
                        ></fw-form-control>
                        <fw-form-control type="DROPDOWN" id="condition_field" name="condition_field" label="Field" placeholder="Select Field"></fw-form-control>
                    </fw-form>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px">
                        <fw-button id="new-condition" color="secondary">Add New</fw-button>
                    </div>
                    <fw-data-table id="data-table-values" label="Values"></fw-data-table>
                </fw-tab-panel>
                <fw-tab-panel name="file">
                    <fw-form id="formDocument">
                        <fw-form-control
                            type="MULTI_SELECT"
                            id="custom_object_id"
                            name="custom_object_id"
                            label="Related Custom Object"
                            required="true"
                            placeholder="Select Related Custom Object"
                        ></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="document_template_code"
                            name="document_template_code"
                            label="Select Document Template"
                            placeholder="Select Document Template"
                            required="true"
                        ></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="output_type"
                            name="output_type"
                            label="Output Type"
                            required="true"
                            placeholder="Select type"
                        ></fw-form-control>
                        <fw-form-control type="CHECKBOX" id="attach_to_ticket" name="attach_to_ticket" label="Attach to Ticket"></fw-form-control>
                        <fw-form-control type="CHECKBOX" id="create_attachment" name="create_attachment" label="Create Attachment"></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="attachment_object_id"
                            name="attachment_object_id"
                            label="Attachment Object"
                            required="true"
                            placeholder="Select Attachment Object"
                        ></fw-form-control>
                        <fw-form-control
                            type="CHECKBOX"
                            id="send_email_attachment"
                            name="send_email_attachment"
                            label="Send Email Attachment"
                        ></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="file_email_template"
                            name="email_template_code"
                            label="Email Template"
                            placeholder="Select Email Template"
                        ></fw-form-control>
                        <fw-form-control
                            type="DROPDOWN"
                            id="agent_groups_id"
                            name="agent_groups_id"
                            label="Send Email to Agent Groups"
                            placeholder="Select Agent Groups"
                        ></fw-form-control>
                        <fw-form-control
                            type="MULTI_SELECT"
                            id="requester_groups_id"
                            name="requester_groups_id"
                            label="Send Email to Requester Groups"
                            placeholder="Select Requester Groups"
                        ></fw-form-control>
                        <fw-form-control
                            type="PARAGRAPH"
                            id="to_list"
                            name="to_list"
                            label="Send To (list email ; separator)"
                            placeholder="Enter Email"
                        ></fw-form-control>
                        <fw-form-control type="DROPDOWN" id="new_state" name="new_state" label="New State" placeholder="Select State"></fw-form-control>
                    </fw-form>
                </fw-tab-panel>
            </fw-tabs>
            <div class="bottom">
                <fw-button id="closeModal" color="secondary">Close</fw-button>
                <fw-button id="submit" color="primary">Save</fw-button>
            </div>
        </div>
        <fw-modal id="modal-detail">
            <fw-modal-title>
                <span>Condition Configuration</span>
            </fw-modal-title>
            <fw-modal-content>
                <fw-form id="form-condition">
                    <fw-form-control type="DROPDOWN" id="condition-state" name="state" label="State" placeholder="Select State"></fw-form-control>
                    <fw-form-control type="DROPDOWN" disabled id="condition_detail_field" name="condition_detail_field" label="Field"></fw-form-control>
                    <fw-form-control type="DROPDOWN" id="operator" name="operator" label="Operator" placeholder="Select Operator"></fw-form-control>
                    <fw-form-control type="PARAGRAPH" id="value" name="value" label="Value (Separated by ;)" placeholder="Enter Value"></fw-form-control>
                </fw-form>
            </fw-modal-content>
            <fw-modal-footer>
                <fw-button id="form-condition-close" color="secondary">Close</fw-button>
                <fw-button id="form-condition-add">Add</fw-button>
                <fw-button id="form-condition-save">Save</fw-button>
            </fw-modal-footer>
        </fw-modal>
        <script src="https://static.freshdev.io/fdk/2.0/assets/fresh_client.js"></script>
        <script type="module" src="https://cdn.jsdelivr.net/npm/@freshworks/crayons@v4/dist/crayons/crayons.esm.js"></script>
        <script nomodule src="https://cdn.jsdelivr.net/npm/@freshworks/crayons@v4/dist/crayons/crayons.js"></script>
        <script src="../scripts/constant.js"></script>
        <script src="../scripts/helper.js"></script>
        <script src="../scripts/condition.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                window.frsh_init().then(function (client) {
                    var context = {};
                    var categories = [];
                    var states = [];
                    var formCreate = document.querySelector("#formCreate");
                    var formApproval = document.querySelector("#formApproval");
                    var formDocument = document.querySelector("#formDocument");
                    var formCondition = document.querySelector("#formCondition");
                    generateSelect();
                    generateDataTable([], []);
                    document.getElementById("closeModal").addEventListener("click", function () {
                        client.instance.close();
                    });
                    formCreate.addEventListener("fwFormValueChanged", (e) => {
                        if (e.detail.field == "app_code") {
                            generateProcess(
                                categories?.filter((item) => item.data.app_code == e.detail.value),
                                ""
                            );
                        }
                        if (e.detail.field == "process_code") {
                            const newStateList = states?.filter(
                                (item) => item.data.app_code == document.getElementById("app_code").value && item.data.process_code == e.detail.value
                            );
                            generateState("current_state", newStateList, context);
                            generateState("new_state", newStateList, context);
                            generateState("expired_new_state", newStateList, context);
                            generateState("condition-state", newStateList, context);
                            client.instance.send({
                                message: {
                                    type: ACTION_TYPES.SERVICE_ITEM,
                                    data: {
                                        app_code: document.getElementById("app_code").value,
                                        process_code: e.detail.value
                                    }
                                }
                            });
                        }
                    });
                    formApproval.addEventListener("fwFormValueChanged", (e) => {
                        if (e.detail.field == "approver") {
                            if (e.detail.value == 4) {
                                document.getElementById("next_approval_group").disabled = false;
                                document.getElementById("next_agent_group_approval").disabled = false;
                            } else {
                                document.getElementById("next_approval_group").disabled = true;
                                document.getElementById("next_agent_group_approval").disabled = true;
                            }
                        }
                    });
                    formCondition.addEventListener("fwFormValueChanged", (e) => {
                        if (e.detail.field == "object_type") {
                            const type = e.detail.value;
                            generateFields("condition_field", []);
                            if (type === "custom_object") {
                                document.getElementById("condition_custom_object").style.display = "block";
                            } else {
                                document.getElementById("condition_custom_object").style.display = "none";
                                client.instance.send({
                                    message: {
                                        type: ACTION_TYPES.GET_FIELDS_BY_TYPE,
                                        data: {
                                            app_code: document.getElementById("app_code").value,
                                            process_code: document.getElementById("process_code").value,
                                            object_type: e.detail.value
                                        }
                                    }
                                });
                            }
                        }
                        if (e.detail.field == "custom_object_id") {
                            const object_type = document.getElementById("object_type").value;
                            if (object_type !== "custom_object") return;
                            client.instance.send({
                                message: {
                                    type: ACTION_TYPES.GET_FIELDS_BY_TYPE,
                                    data: {
                                        object_type: "custom_object",
                                        object_id: e.detail.value
                                    }
                                }
                            });
                        }
                    });
                    document.querySelector("#submit").addEventListener("click", async (e) => {
                        const { values, isValid } = await formCreate.doSubmit(e);
                        if (values.configuration_type === "file") {
                            const { values: template } = await formDocument.doSubmit(e);
                            const dataDocument = {
                                state_change_id: String(values.bo_display_id),
                                custom_object_id: template.custom_object_id?.join(";"),
                                output_type: template.output_type,
                                document_template_code: template.document_template_code,
                                attach_to_ticket: Number(template.attach_to_ticket),
                                create_attachment: Number(template.create_attachment),
                                attachment_object_id: template.attachment_object_id,
                                send_email_attachment: Number(template.send_email_attachment),
                                email_template_code: template.email_template_code,
                                agent_groups_id: template.agent_groups_id?.join(";"),
                                requester_groups_id: template.requester_groups_id?.join(";"),
                                to_list: template.to_list,
                                new_state: template.new_state
                            };
                            client.instance.send({
                                message: {
                                    type: ACTION_TYPES.FILE_GENERATION,
                                    data: dataDocument,
                                    id: template?.bo_display_id
                                }
                            });
                        }
                        if (values.configuration_type === "approval") {
                            const { values: approval } = await formApproval.doSubmit(e);
                            client.instance.send({
                                message: {
                                    type: ACTION_TYPES.APPROVAL_STATE,
                                    data: {
                                        ...approval,
                                        state_change_id: String(values.bo_display_id),
                                        send_warning_email_before: approval.send_warning_email_before?.join(";")
                                    },
                                    id: approval?.bo_display_id
                                }
                            });
                        }
                        if (values.configuration_type === "condition") {
                            const { values: condition } = await formCondition.doSubmit(e);
                            const table = document.getElementById("data-table-values");
                            await table.selectAllRows();
                            const tableValues = await table.getSelectedRows();
                            client.instance.send({
                                message: {
                                    type: ACTION_TYPES.CONDITIONS_CONFIGURATION,
                                    data: {
                                        ...condition,
                                        state_change_id: String(values.bo_display_id),
                                        condition_values: JSON.stringify(tableValues)
                                    },
                                    id: condition?.bo_display_id
                                }
                            });
                        }
                        client.instance.send({
                            message: {
                                type: context.type,
                                data: values,
                                id: context.detail?.bo_display_id
                            }
                        });
                    });
                    client.instance.receive(function (event) {
                        let data = event.helper.getData();
                        if (data.type === ACTION_TYPES.CLOSE_MODAL) client.instance.close();
                        if (data.type === ACTION_TYPES.RELATED_CUSTOM_OBJECT) {
                            const list = data.data;
                            generateCustomObject("condition_custom_object", list);
                            formCondition.setFieldValue("custom_object_id", context.data.condition?.data.custom_object_id);
                        }
                        if (data.type === ACTION_TYPES.GET_FIELDS_BY_TYPE) {
                            const list = data.data;
                            generateFields("condition_field", list);
                            generateFields("condition_detail_field", list);
                            formCondition.setFieldValue("condition_field", context.data.condition?.data?.condition_field);
                        }
                        if (data.type === ACTION_TYPES.CUSTOM_OBJECT) {
                            const list = data.data;
                            generateCustomObject("custom_object_id", list);
                            generateCustomObject("attachment_object_id", list);
                            formDocument.setFieldValue("custom_object_id", context.data.template?.data.custom_object_id?.split(";"));
                            formDocument.setFieldValue("attachment_object_id", context.data.template?.data.attachment_object_id);
                        }
                    });
                    client.instance.context().then(function (c) {
                        context = c.data;
                        if (context.type === ACTION_TYPES.GROUP_APPROVAL_CREATE || context.type === ACTION_TYPES.GROUP_APPROVAL_UPDATE) {
                            const { detail, data } = context;
                            categories = data.categories;
                            states = data.states;
                            generateApp(data.apps, context.detail?.app_code);
                            generateProcess(
                                categories?.filter((item) => item.data.app_code == context.detail?.app_code),
                                ""
                            );
                            generateGroup("next_approval_group", data.requesterGroups, context);
                            generateGroup("next_agent_group_approval", data.agentGroups, context);
                            generateGroup("requester_groups_id", data.requesterGroups, context);
                            generateGroup("agent_groups_id", data.agentGroups, context);
                            const newStates = states?.filter(
                                (item) => item.data.app_code == context.detail?.app_code && item.data.process_code == context.detail?.process_code
                            );
                            generateState("current_state", newStates, context);
                            generateState("expired_new_state", newStates, context);
                            generateState("condition-state", newStates, context);
                            generateState("new_state", newStates, context);
                            generateEmailTemplate("email_template_code", data.templates, context);
                            generateEmailTemplate("warning_email_template_code", data.templates, context);
                            generateEmailTemplate("file_email_template", data.templates, context);
                            generateDocumentTemplate("document_template_code", data.documentTemplates, context);

                            if (!detail) return;
                            Object.keys(detail).forEach(function (key) {
                                formCreate.setFieldValue([key], detail[key]);
                            });
                            setTimeout(() => {
                                if (data.approval) {
                                    if (data.approval.approver == 4) {
                                        document.getElementById("next_approval_group").disabled = false;
                                        document.getElementById("next_agent_group_approval").disabled = false;
                                    }
                                    Object.keys(data.approval.data).forEach(function (key) {
                                        if (["send_warning_email_before"].includes(key)) formApproval.setFieldValue([key], data.approval.data[key]?.split(";"));
                                        else formApproval.setFieldValue([key], data.approval.data[key]);
                                    });
                                }
                                if (data.template) {
                                    Object.keys(data.template.data).forEach(function (key) {
                                        if (["custom_object_id", "requester_groups_id"].includes(key))
                                            formDocument.setFieldValue([key], data.template.data[key].split(";"));
                                        else formDocument.setFieldValue([key], data.template.data[key]);
                                    });
                                }
                                if (data.condition) {
                                    Object.keys(data.condition.data).forEach(function (key) {
                                        formCondition.setFieldValue([key], data.condition.data[key]);
                                    });
                                    generateDataTable(data.condition.data.condition_values, newStates);
                                }
                            }, 500);
                        }
                    });
                });
                function generateSelect() {
                    const calendar_type = [
                        { value: "business", text: "8/5 Calendar" },
                        { value: "normal", text: "24/7 Calendar" }
                    ];
                    const configuration_type = [
                        { value: "approval", text: "Approval" },
                        { value: "condition", text: "Condition" },
                        { value: "file", text: "Generate File" }
                    ];
                    const approver = [
                        { value: "1", text: "Reporting Manager" },
                        { value: "2", text: "Department Head" },
                        { value: "3", text: "Selected Department" },
                        { value: "4", text: "Group" }
                    ];
                    const approval_type = [
                        { value: "1", text: "To be approved by Everyone" },
                        { value: "2", text: "To be approved by Anyone" },
                        { value: "3", text: "To be approved by Majority" },
                        { value: "4", text: "To be approved by First Responder" }
                    ];
                    const send_warning_email_before = [
                        { value: "1day", text: "1 day" },
                        { value: "4hours", text: "4 hours" },
                        { value: "1hours", text: "1 hours" },
                        { value: "30mins", text: "30 mins" }
                    ];
                    const operator = [
                        { value: "condition", text: "Condition" },
                        { value: "equals", text: "Equals" },
                        { value: "contains", text: "Contains" },
                        { value: "between", text: "Between" },
                        { value: "greater_than", text: "Greater than" },
                        { value: "greater_than_or_equal", text: "Greater than or Equal to" },
                        { value: "less_than", text: "Less than" },
                        { value: "less_than_or_equal", text: "Less than or Equal to" }
                    ];
                    const output_type = [
                        { value: "pdf", text: "PDF" },
                        { value: "docx", text: "Word" },
                        { value: "xlsx", text: "Excel" }
                    ];

                    const object_type = [
                        { value: "ticket", text: "Ticket" },
                        { value: "service_request", text: "Service Request" },
                        { value: "custom_object", text: "Custom Object" }
                    ];

                    document.getElementById("calendar_type").choices = calendar_type;
                    document.getElementById("approver").choices = approver;
                    document.getElementById("approval_type").choices = approval_type;
                    document.getElementById("configuration_type").choices = configuration_type;
                    document.getElementById("send_warning_email_before").choices = send_warning_email_before;
                    document.getElementById("operator").choices = operator;
                    document.getElementById("output_type").choices = output_type;
                    document.getElementById("object_type").choices = object_type;
                }
            });
        </script>
    </body>
</html>
